---
layout: post
title:  "批量下载NCBI所有物种的基因组序列"
date:   2017-04-15 19:34:55
categories: 生物信息学
tags: NCBI 基因组
excerpt: 通过命令行下载NCBI上某一类别（例如：植物）下的所有物种的基因组序列
---

* content
{:toc}

## 简要

*   最近一个月一直在忙活毕业论文的事情，对技术研究比较少，一直都在看关于生物信息方面的知识。

*   给大家分享一下我在做本地blast时遇到的大坑。


## 摘要

*   一般情况下只需要按照正常套路在 NCBI 下载指定的物种即可，但是特殊情况下，需要下载整个真菌、植物、古生菌……的基因组，就需要用到下面的方法了。

*   这里以批量下载真菌下面的所有物种的基因组序列为例介绍，包括基因组的下载、基因组文件的合并、数据库的格式化等过程


##  基因组的批量下载

>   通过拼接获取所有物种的下载地址

*   打开cmd命令窗口输入以下内容

```shell
curl 'ftp://ftp.ncbi.nlm.nih.gov/genomes/refseq/fungi/assembly_summary.txt'|\ 
awk '{FS="\t"}!/^#/{print $20}'|\  
sed -r 's|(ftp://ftp.ncbi.nlm.nih.gov/genomes/all/.+/)(GCF_.+)|\1\2/\2_genomic.fna.gz|'>genomic_file
```

*   运行完会得到一个包含所有下载地址的文件 ~genomic_file~

>   通过wget命令下载此文件中的所有ftp地址

```shell
wget -i genomic_file.txt
```

*   下载速度取决于网速，下载完成后批量解压

*   打开ftp地址（ftp://ftp.ncbi.nlm.nih.gov/genomes/refseq/）
    
![Object](http://jiaohongwei.github.io/images/2017-04/20170426173125.png)


*   如果要下载其他的分类，只需要把fungi 换成 plant 就可以了。

##  文件的合并

*   合并所有的fasta文件 ，如果文件少的话可以通过~BioEdit~这款软件来做，导入导出就可以了，很简单。

*   但是如果文件数量比较多，就容易造成软件蹦四，因此我写了一段代码用来合并同一文件夹下的所有的fasta文件，因为不会perl语言，所有用java写得

```java
package bio;

import java.io.*;
import java.util.ArrayList;
import java.util.Scanner;

/**
 * Created by jiaohongwei on 2017/4/13.
 */
public class Test2 {
    // 将多个文件合成一个文件，其中fileNames是一个字符串数组，包括了所有参加合并操作的文件的全路径，TargetFileName指的是合成后的文件的全路径
    public static void merge(String[] fileNames, String TargetFileName)
            throws Exception {


        Scanner sc = null;

        BufferedWriter output = new BufferedWriter(new FileWriter(TargetFileName));
        for (int i = 0; i < fileNames.length; i++) {
            FileInputStream inputStream =  new FileInputStream(fileNames[i]);
            sc = new Scanner(inputStream, "UTF-8");

            long start_time = System.currentTimeMillis();
            while (sc.hasNextLine()) {
                String line = sc.nextLine();
                output.newLine();
                output.write(line);
            }
            long end = System.currentTimeMillis();
            System.out.println("第"+(i+1)+"个文件读取结束，共耗时：" + (end - start_time) / 1000 + "s");
            // note that Scanner suppresses exceptions
            if (sc.ioException() != null) {
                throw sc.ioException();
            }
            inputStream.close();
        }
        output.close();
        System.out.println("合并文件" + TargetFileName + "成功");
    }

    public static void readFileMessage(String fileName) {// 将合成的文件中的内容读出
        File file = new File(fileName);
        BufferedReader reader = null;
        try {
            reader = new BufferedReader(new FileReader(file));
            String string = null;
            // 按行读取内容，直到读入null则表示读取文件结束
            while ((string = reader.readLine()) != null) {
                System.out.println(string);
            }
            reader.close();
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            if (reader != null) {
                try {
                    reader.close();
                } catch (IOException e1) {
                }
            }
        }
    }

    public static void main(final String[] args) throws Exception {

        ArrayList<File> files = getListFiles("E:\\Database\\指定物种");
        // 合并文件

        int len = files.size();
        String[] fileNames = new String[len];
        for (int i = 0; i < files.size(); i++) {
            fileNames[i] = String.valueOf(files.get(i));
        }
        String newFileName = "H:\\blast-2.5.0\\db\\Temp\\temp_NCBI.fasta";

        merge(fileNames, newFileName);


    }

    /***
     * 获取指定目录下的所有的文件（不包括文件夹），采用了递归
     *
     * @param obj
     * @return
     */
    public static ArrayList<File> getListFiles(Object obj) {
        File directory = null;
        if (obj instanceof File) {
            directory = (File) obj;
        } else {
            directory = new File(obj.toString());
        }
        ArrayList<File> files = new ArrayList<File>();
        if (directory.isFile()) {
            files.add(directory);
            return files;
        } else if (directory.isDirectory()) {
            File[] fileArr = directory.listFiles();
            for (int i = 0; i < fileArr.length; i++) {
                File fileOne = fileArr[i];
                files.addAll(getListFiles(fileOne));
            }
        }
        return files;
    }

}


```

##  格式化数据库

*   fasta文件合并完成后需要格式化数据库才能用

```
makeblastdb -in Fungi.fasta -dbtype nucl -out FungiDB
```

##  blast

```
blastn -query seq.fasta -db FungiDB -out result.txt
```

##  源文档


*   关于windows下本地blast，大家可以参考华大基因的ppt文档，在百度文库有

*   http://wenku.baidu.com/link?url=VFMJNCfStTzbAg3NOjFvwuLo2Yoc95-XnnAY2P2Pk3Zplc_eWAPoeREeuCcvJDNaLu3RuJawaflYxEnsJU3t8joknZwfhyzq2qEnimsiAyK

